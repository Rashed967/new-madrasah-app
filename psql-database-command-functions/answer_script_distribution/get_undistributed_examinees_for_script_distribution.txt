-- Renamed and refactored function
CREATE OR REPLACE FUNCTION public.get_undistributed_scripts_for_distribution(
    p_exam_id UUID,
    p_marhala_id UUID,
    p_kitab_id UUID
)
RETURNS TABLE (
    examinee_id UUID,
    registration_number INTEGER,
    roll_number INTEGER,
    examinee_name_bn TEXT,
    madrasa_id UUID,
    madrasa_name_bn TEXT,
    markaz_id UUID,
    markaz_name_bn TEXT
)
LANGUAGE sql STABLE SECURITY DEFINER AS $$
    -- This function retrieves all examinees for a specific exam, marhala, and kitab
    -- who have not yet had their script for that kitab distributed.
    SELECT
        ex.id AS examinee_id,
        ex.registration_number,
        ex.roll_number,
        ex.name_bn AS examinee_name_bn,
        ex.madrasa_id,
        mad.name_bn AS madrasa_name_bn,
        mma.markaz_id,
        mk.name_bn AS markaz_name_bn
    FROM public.examinees ex
    JOIN public.madrasas mad ON ex.madrasa_id = mad.id
    -- Find the markaz the examinee is assigned to for this exam and marhala
    JOIN public.markaz_madrasa_marhala_assignments mma 
        ON ex.madrasa_id = mma.madrasa_id 
        AND ex.marhala_id = mma.marhala_id 
        AND ex.exam_id = mma.exam_id
    JOIN public.markazes mk ON mma.markaz_id = mk.id
    -- Ensure the examinee's marhala has the selected kitab
    JOIN public.marhalas mar ON ex.marhala_id = mar.id AND p_kitab_id = ANY(mar.kitab_ids)
    WHERE ex.exam_id = p_exam_id
      AND ex.marhala_id = p_marhala_id
      AND ex.status = 'roll_assigned' -- Only examinees whose rolls are assigned are ready for evaluation
      AND NOT EXISTS ( -- The crucial check: not already distributed for this specific exam and kitab
          SELECT 1
          FROM public.distributed_script_details dsd
          WHERE dsd.examinee_id = ex.id
            AND dsd.exam_id = p_exam_id
            AND dsd.kitab_id = p_kitab_id
      )
    ORDER BY mk.name_bn, mad.name_bn, ex.roll_number ASC NULLS LAST;
$$;

GRANT EXECUTE ON FUNCTION public.get_undistributed_scripts_for_distribution(UUID, UUID, UUID) TO authenticated;

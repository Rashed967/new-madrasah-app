
-- ===================================================================
-- RPC Function: get_general_mumtahins_for_exam
-- Purpose: Fetch Mumtahins who are assigned exam-wide (markaz_id IS NULL and assigned_marhala_id IS NULL).
-- Returns: JSONB object { assignments: ExamPersonnelAssignment[], totalItems: number }
-- ===================================================================
CREATE OR REPLACE FUNCTION public.get_general_mumtahins_for_exam(
    p_exam_id UUID
)
RETURNS JSONB -- Consistent with other list functions
LANGUAGE plpgsql
STABLE -- It only reads data
SECURITY DEFINER
AS $$
DECLARE
    _items_jsonb JSONB;
    _total_items INTEGER;
    _query TEXT;
BEGIN
    IF p_exam_id IS NULL THEN
        RAISE EXCEPTION 'পরীক্ষা আইডি আবশ্যক।';
    END IF;

    _query := format(
        $QUERY$
        SELECT
            epa.id AS assignment_id,
            epa.assigned_role, 
            epa.assigned_marhala_id, 
            epa.negran_type, 
            epa.created_at AS assignment_created_at,
            t.id AS personnel_id,
            t.teacher_code AS personnel_code,
            t.name_bn AS personnel_name_bn,
            t.mobile AS personnel_mobile,
            (SELECT m_edu.name_bn FROM public.marhalas m_edu WHERE m_edu.id = t.educational_qualification LIMIT 1) AS educational_qualification_name_bn,
            (
                SELECT jsonb_agg(k.name_bn)
                FROM public.kitabs k
                WHERE t.kitabi_qualification IS NOT NULL AND k.id = ANY(t.kitabi_qualification) -- Simplified for UUID[]
            ) AS kitabi_qualification_names
        FROM public.exam_personnel_assignments epa
        JOIN public.teachers t ON epa.personnel_id = t.id
        WHERE epa.exam_id = %L
          AND epa.assigned_role = 'mumtahin'
          AND epa.markaz_id IS NULL       
          AND epa.assigned_marhala_id IS NULL 
        ORDER BY t.name_bn
        $QUERY$,
        p_exam_id
    );

    EXECUTE 'SELECT COALESCE(jsonb_agg(row_to_json(q)), ''[]''::jsonb) FROM (' || _query || ') q' INTO _items_jsonb;
    _total_items := COALESCE(jsonb_array_length(_items_jsonb), 0); 

    RETURN jsonb_build_object('assignments', _items_jsonb, 'totalItems', _total_items);
END;
$$;

GRANT EXECUTE ON FUNCTION public.get_general_mumtahins_for_exam(UUID) TO authenticated;

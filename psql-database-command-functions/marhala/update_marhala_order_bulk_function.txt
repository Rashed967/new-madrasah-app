CREATE OR REPLACE FUNCTION public.update_marhala_order_bulk(p_ordered_ids UUID[])
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_id UUID;
    v_order INTEGER;
BEGIN
    IF p_ordered_ids IS NULL OR array_length(p_ordered_ids, 1) IS NULL THEN
        RAISE EXCEPTION 'সাজানো আইডির তালিকা খালি হতে পারবে না।';
    END IF;

    v_order := 1;
    FOREACH v_id IN ARRAY p_ordered_ids
    LOOP
        UPDATE public.marhalas
        SET marhala_order = v_order,
            updated_at = NOW() 
        WHERE id = v_id;
        v_order := v_order + 1;
    END LOOP;
END;
$$;
GRANT EXECUTE ON FUNCTION public.update_marhala_order_bulk(UUID[]) TO authenticated;
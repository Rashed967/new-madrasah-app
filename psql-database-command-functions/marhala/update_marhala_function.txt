CREATE OR REPLACE FUNCTION public.update_marhala(
    p_id UUID,
    p_name_bn TEXT,
    p_name_ar TEXT,
    p_type TEXT, -- 'boys' or 'girls'
    p_category TEXT, -- 'darsiyat' or 'hifz'
    p_kitab_ids UUID[],
    p_requires_photo BOOLEAN DEFAULT FALSE -- Added parameter
)
RETURNS marhalas -- Returns the updated marhala row
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_updated_marhala marhalas%ROWTYPE;
BEGIN
    -- Input Validation
    IF p_id IS NULL THEN
        RAISE EXCEPTION 'মারহালা আইডি আবশ্যক।';
    END IF;
    IF p_name_bn IS NULL OR p_name_bn = '' THEN
        RAISE EXCEPTION 'মারহালার বাংলা নাম আবশ্যক।';
    END IF;
    IF p_type IS NULL OR NOT (p_type = 'boys' OR p_type = 'girls') THEN
        RAISE EXCEPTION 'মারহালার ধরণ অবশ্যই ''boys'' অথবা ''girls'' হতে হবে।';
    END IF;
    IF p_category IS NULL OR NOT (p_category = 'darsiyat' OR p_category = 'hifz') THEN
        RAISE EXCEPTION 'মারহালার ক্যাটাগরি অবশ্যই ''darsiyat'' অথবা ''hifz'' হতে হবে।';
    END IF;

    -- Check for duplicate Bengali name for the same type (excluding the current marhala)
    PERFORM 1 FROM public.marhalas WHERE name_bn = p_name_bn AND type = p_type AND id <> p_id;
    IF FOUND THEN
        RAISE EXCEPTION 'এই বাংলা নামে এবং একই ধরনের আরেকটি মারহালা ইতিমধ্যে বিদ্যমান: "%"', p_name_bn
        USING ERRCODE = '23505'; -- unique_violation
    END IF;

    -- Update the marhala
    UPDATE public.marhalas
    SET
        name_bn = p_name_bn,
        name_ar = p_name_ar,
        type = p_type,
        category = p_category,
        kitab_ids = p_kitab_ids,
        requires_photo = COALESCE(p_requires_photo, requires_photo, FALSE), -- Update requires_photo
        updated_at = NOW()
    WHERE id = p_id
    RETURNING * INTO v_updated_marhala;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'প্রদত্ত আইডি (%) সহ কোনো মারহালা পাওয়া যায়নি।', p_id;
    END IF;

    RETURN v_updated_marhala;
END;
$$;
GRANT EXECUTE ON FUNCTION public.update_marhala(UUID, TEXT, TEXT, TEXT, TEXT, UUID[], BOOLEAN) TO authenticated;
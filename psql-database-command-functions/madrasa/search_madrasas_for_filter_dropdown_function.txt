
CREATE OR REPLACE FUNCTION public.search_madrasas_for_filter_dropdown(
    p_page INTEGER DEFAULT 1,
    p_limit INTEGER DEFAULT 10,
    p_search_term TEXT DEFAULT NULL
)
RETURNS JSONB -- Returns { items: SelectOption[], totalItems: number }
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    _query TEXT;
    _count_query TEXT;
    _offset INTEGER;
    _total_items INTEGER;
    _items_jsonb JSONB;
    _search_condition TEXT;
BEGIN
    _offset := (p_page - 1) * p_limit;

    -- If no search term is provided, return all madrasas. Otherwise, filter by the search term.
    IF p_search_term IS NULL OR p_search_term = '' THEN
        _search_condition := 'WHERE TRUE';
    ELSE
        _search_condition := format('WHERE name_bn ILIKE %1$L OR madrasa_code::TEXT ILIKE %1$L', '%' || p_search_term || '%');
    END IF;

    _count_query := 'SELECT COUNT(*) FROM public.madrasas ' || _search_condition;
    EXECUTE _count_query INTO _total_items;

    _query := '
        SELECT jsonb_agg(jsonb_build_object(
                            ''value'', id, 
                            ''label'', name_bn || '' (কোড: '' || madrasa_code || '')''
                        ))
        FROM (
            SELECT id, name_bn, madrasa_code
            FROM public.madrasas
            ' || _search_condition || '
            ORDER BY name_bn ASC
            LIMIT ' || p_limit || ' OFFSET ' || _offset || '
        ) AS subquery';
    
    EXECUTE _query INTO _items_jsonb;

    RETURN jsonb_build_object('items', COALESCE(_items_jsonb, '[]'::jsonb), 'totalItems', _total_items);
END;
$$;

GRANT EXECUTE ON FUNCTION public.search_madrasas_for_filter_dropdown(INTEGER, INTEGER, TEXT) TO authenticated;
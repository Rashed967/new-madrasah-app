
CREATE OR REPLACE FUNCTION public.update_official(
    p_id UUID,
    p_name TEXT,
    p_designation TEXT,
    p_image_url TEXT,
    p_is_active BOOLEAN DEFAULT NULL
)
RETURNS officials
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_updated_official officials%ROWTYPE;
    v_user_role TEXT;
BEGIN
    SELECT role INTO v_user_role FROM public.user_profiles WHERE id = auth.uid();
    IF NOT (v_user_role = 'admin' OR v_user_role = 'super_admin') THEN
        RAISE EXCEPTION 'এই কার্যক্রমের জন্য আপনার অনুমতি নেই।' USING ERRCODE = '42501';
    END IF;

    UPDATE public.officials
    SET
        name = COALESCE(p_name, name),
        designation = COALESCE(p_designation, designation),
        image_url = CASE WHEN p_image_url IS NOT NULL THEN p_image_url ELSE image_url END,
        is_active = COALESCE(p_is_active, is_active),
        updated_at = NOW()
    WHERE id = p_id
    RETURNING * INTO v_updated_official;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'কর্মকর্তা আইডি (%) পাওয়া যায়নি।', p_id;
    END IF;
    
    RETURN v_updated_official;
END;
$$;
GRANT EXECUTE ON FUNCTION public.update_official(UUID, TEXT, TEXT, TEXT, BOOLEAN) TO authenticated;

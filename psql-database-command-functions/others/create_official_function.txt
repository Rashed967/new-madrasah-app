
CREATE OR REPLACE FUNCTION public.create_official(
    p_name TEXT,
    p_designation TEXT,
    p_image_url TEXT DEFAULT NULL,
    p_is_active BOOLEAN DEFAULT TRUE
)
RETURNS officials
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_new_official officials%ROWTYPE;
    v_new_order_index INTEGER;
    v_user_role TEXT;
BEGIN
    SELECT role INTO v_user_role FROM public.user_profiles WHERE id = auth.uid();
    IF NOT (v_user_role = 'admin' OR v_user_role = 'super_admin') THEN
        RAISE EXCEPTION 'এই কার্যক্রমের জন্য আপনার অনুমতি নেই।' USING ERRCODE = '42501';
    END IF;

    IF p_name IS NULL OR TRIM(p_name) = '' THEN RAISE EXCEPTION 'নাম আবশ্যক।'; END IF;
    IF p_designation IS NULL OR TRIM(p_designation) = '' THEN RAISE EXCEPTION 'পদবি আবশ্যক।'; END IF;

    -- Set the order index to be the max existing index + 1
    SELECT COALESCE(MAX(order_index), -1) + 1 INTO v_new_order_index FROM public.officials;
    
    INSERT INTO public.officials (name, designation, image_url, is_active, order_index)
    VALUES (p_name, p_designation, p_image_url, p_is_active, v_new_order_index)
    RETURNING * INTO v_new_official;

    RETURN v_new_official;
END;
$$;
GRANT EXECUTE ON FUNCTION public.create_official(TEXT, TEXT, TEXT, BOOLEAN) TO authenticated;

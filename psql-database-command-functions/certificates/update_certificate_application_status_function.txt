
CREATE OR REPLACE FUNCTION public.update_certificate_application_status(
    p_application_id UUID,
    p_new_status TEXT,
    p_admin_notes TEXT DEFAULT NULL
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_role TEXT;
BEGIN
    SELECT role INTO v_user_role FROM public.user_profiles WHERE id = auth.uid();
    IF NOT (v_user_role = 'admin' OR v_user_role = 'super_admin') THEN
        RAISE EXCEPTION 'স্ট্যাটাস পরিবর্তনের অনুমতি আপনার নেই।' USING ERRCODE = '42501';
    END IF;

    IF NOT (p_new_status IN ('pending', 'processing', 'ready_for_delivery', 'completed', 'rejected')) THEN
        RAISE EXCEPTION 'অবৈধ স্ট্যাটাস।';
    END IF;

    UPDATE public.certificate_applications
    SET 
        application_status = p_new_status,
        notes_by_admin = COALESCE(p_admin_notes, notes_by_admin),
        updated_at = NOW()
    WHERE id = p_application_id;
END;
$$;
GRANT EXECUTE ON FUNCTION public.update_certificate_application_status(UUID, TEXT, TEXT) TO authenticated;
